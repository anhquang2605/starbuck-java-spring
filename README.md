# CMPE 172 Project Journal

## Overall Cloud Architecture diagram
![img](./images/starbuck%20cloud%20diagram.png)
## Feature
#### Cashier's App
![img](./images/cashier/log%20in%20screen.PNG)
![img](./images/cloud%20deployment/signed%20in%20with%20signout%20button.PNG)
##### Dicussion about the feature
For this feature, I used the implementation from the mid term code. Added changes to action handler in the controller to call to the starbuck api endpoints and retrieve items from the endpoints and render the result to the view templates. I removed logic to store order in mysql directly from cashier and let the starbuck api handle mysql call instead. I Also added custom user log in form and allow user to sign up for new account.
![img](./images/cloud%20deployment/new%20user%20created%20in%20mysql.PNG)
This new account will be saved in mysql database in stead of in memory. 
![img](./images/cloud%20deployment/4%20cashier%20services.PNG)
The cashier app is deplopyed to GKE and work behind spring-cashier-ingress load balancer. This load balancer will handle 4 cashier services and would redirect traffic to appropriate service. For the screen shot demos please have a look in the Technical requirements section

#### Starbuck Rest API 
![img](./images/starbuck%20api/Starbuck%20rest%20API%20gneral.PNG)
##### Dicussion about the feature
This feature will have some changes, first of all I included a new api endpoint named drink to check drink status from the drinks table. This drinks table stores all the drinks that were fulfilled
![img](./images/starbuck%20api/Drink%20controller%20for%20drink%20API%20endpoint.PNG)
Drink class and drinks table is introduced
![img](./images/starbuck%20api/Drink%20class%20and%20table%20to%20keep%20track%20of%20drink%20item%20and%20fulfilled%20orders.PNG)
Second change is in the starbuck api service and models, I introduced Active Order class and table to store active order of a store instead of using hash map, since api should be stateless, I should let the api store the state in mysql instead in active order table
![img](./images/starbuck%20api/active%20order%20class%20and%20table%20to%20store%20active%20order%20of%20current%20store.PNG)

#### Cloud Deployments
##### Cluster 172
![img](./images/cloud%20deployment/cluster%20172.PNG)
##### Deployments
![img](./images/cloud%20deployment/deployments%20on%20GKE.PNG)
##### Services
![img](./images/cloud%20deployment/services%20on%20GKE.PNG)
##### Ingress
![img](./images/ingress%20for%20starbuck%20api%20service%20and%20cashier%20service.PNG)
##### Dicussion about the feature
I deployed services in the cluster name 172. The deployments consist of the spring-starbuck-api, spring-cashier app, rabbit mq and spring-cashier-worker. I ultilized ingress to control traffic among the services replicas of starbuck-api services and spring-cashier-service. Rabbit mq was deployed in a single pod containing service component for internal communication from spring-cashier-service and spring-cashier-worker and console component for browser to access the console page to view the information about the rabbit mq queues. I also used Mysql cloud as back end to persist data generated by rabbit More detail of implementation and setting will be dicuss in the following sections. The solution should be able to handle traffic of over 1 million mobile devices since Kubernetes has the ability to dynamically adjust its resources based on demand. During periods of high traffic, it can automatically create additional instances to manage the increased load. Once the traffic subsides, it can decommission these extra instances to conserve resources.

## Techhnical requirements
#### Cashier's App (25 points)
### Web rendering must be done in View Templates
For this I simple follow the provided code for spring gumbal 3.5, I added some more folders to store landing page for user, admin, and also about us html for ingress health check
##### Overall templates folder
![img](./images/template%20folder%20structure.PNG)
##### starbucks template
![img](./images/view%20template%20proof/starbuck%20html.PNG)
##### login form template
![img](./images/view%20template%20proof/login%20sign%20up%20form.PNG)
##### about us template
![img](./images/view%20template%20proof/about%20us%20html.PNG)

### Controller must process JSON responses from API and pass to View via Models and Implementation must not just use Rest Client example code (from instructor) as-is
For this I simply take advantage of the message returned after the call to api in cashier app and access properties of the order directly via the message object
##### Controller handle message from post new order api after clicking place order
![img](./images/cashier/placing%20new%20order.PNG)
##### Controller handle message from get order api after clicking get order
![img](./images/cashier/Get%20order%20message%20from%20get%20order%20API%20and%20display%20the%20order%20on%20the%20view%20and%20handle%20sending%20message%20to%20cashier%20queue%20for%20worker%20to%20handle%20laater.PNG)
##### Controller handle message from clear order action
![img](./images/cashier/clear%20order%20from%20cashier.PNG)
Output and "Look and Feel" of Web UI must match that of Node.js App
![img](./images/cashier/log%20in%20screen.PNG)
![img](./images/cloud%20deployment/signed%20in%20with%20signout%20button.PNG)

### Support Admin Logins for Starbucks Employees (5 points)
    Must not store credentials in memory or hard code in source code
    Should also include New Account Registration and Logout
![img](./images/cashier/log%20in%20screen.PNG)
![img](./images/cloud%20deployment/signed%20in%20with%20signout%20button.PNG)
#### Creating new user
![img](./images/cashier/creating%20new%20user.PNG)
User persisted in database after the sign up function
![img](./images/cloud%20deployment/new%20user%20created%20in%20mysql.PNG)
#### Logged in with spring session used demonstrated in the mysql database
![img](./images/cloud%20deployment/signed%20in%20with%20signout%20button.PNG)
![img](./images/SPRING%20SESSION%20ASSOCIATED%20WITH%20THE%20RIGHT%20USER%20EMAIL.PNG)


### Support In Store Order Processing (20 points -- See Diagram Below)
#### Start up the app
![img](./images/cashier/log%20in%20screen.PNG)
#### Creating new user
![img](./images/cashier/creating%20new%20user.PNG)
User persisted in database
![img](./images/cloud%20deployment/new%20user%20created%20in%20mysql.PNG)
#### Logged in with spring session used demonstrated in the mysql database
![img](./images/cloud%20deployment/signed%20in%20with%20signout%20button.PNG)
![img](./images/SPRING%20SESSION%20ASSOCIATED%20WITH%20THE%20RIGHT%20USER%20EMAIL.PNG)
#### Start up mobile app using the command and command shown, kong api ip is used to access with the key auth instead of the api key
![img](./images/command%20used%20to%20launch%20mobile%20app.PNG)
#### The card is created after starting up
![img](./images/new%20card%20created%20and%20activated%20after%20log%20in%20the%20app.PNG)
#### New card number matched in database
![img](./images/new%20card%20matched%20in%20database%20from%20the%20mobile%20app.PNG)
#### Placing order and comparing the placed order with the database
![img](./images/order%20placed%20matched%20with%20data%20in%20database.PNG)
#### Pay the order from mobile app, the paid order matched in database, both active and starbuck order table were updated note that the id is 12
![img](./images/order%20paid%20matched%20with%20database.PNG)
#### Rabbit mq queue was empty
![img](./images/rabbit%20mq/rabbit%20mq%20empty%20queue.PNG)
#### Get the paid order, once the order was retrieve from get order api, the app will check the status of such order, since it contains "paid" in the status, the app send the message to cashier queue for worker to handle the order id 12
![img](./images/order%20paid%20sent%20message%20to%20queue.PNG)
#### Worker listen to the cashier queue, got the message and process the order id 12 to make drink
![img](./images/worker%20receieved%20and%20process%20order%20id%2012.PNG)
#### Queue become empty, order fullied and stored in drink table, also updated status fulfilled in active order, ready for the cashier to clear the active order
![img](./images/queue%20emptied%20order%20was%20fulfilled%20saved%20to%20both%20to%20order%20and%20drink.PNG)



#### Scalable Cloud Deployment on GCP  (25 points)
1. External Load Balancer as Ingress for Cashier's App (10 points) and 2. Internal Load Balancer for Starbucks API behind Kong API Gateway (15 points)
![img](./images/ingress%20for%20starbuck%20api%20service%20and%20cashier%20service.PNG)
#### 4 spring cashier services behind the spring cashier ingress one could not started due to code 137 but overall are healthy
![img](./images/cloud%20deployment/4%20cashier%20services.PNG)
#### 4 starbuck api service behind the starbuck api ingress
![img](./images/cloud%20deployment/4%20starbuck%20api%20services%20behind%20ingress.PNG)
#### Kong proxy with external endpoints
![img](./images/cloud%20deployment/kong%20proxy%20with%20external%20endpoints.PNG)

#### Implementation Uses Required Cloud Databases (25 points)
1. MySQL Database 8.0 (15 points)
    Must use Cloud SQL (MySQL Option)
![img](./images/cloud%20deployment/mysql%20cloud%20used.PNG)
#### Cloud mysql is used, provided in environment variable in deployment manifestation proved by the ip Provider ip matched
##### My sql cloud ip in deployment of spring Cashier
![img](./images/cloud%20mysql%20used%20in%20deployment%20for%20cashier.PNG)
##### My sql cloud ip in deployment of spring Starbuck api
![img](./images/mysql%20cloud%20used%20in%20deployment%20for%20starbuck%20api.PNG)
##### My sql cloud ip in deployment of spring Spring worker
![img](./images/single%20resilient%20and%20mysql%20cloud%20used%20for%20spring%20worker.PNG)
    Update Starbucks API to use JPA with MySQL
##### Changed in starbuck service to use JPA with MYSQL instead of using the hash map to store active order, I specify new class Active Order and have JPA generated table active_order to store the active order of current store
###### Change in new order method of starbuck api service
![img](./images/starbuck%20api/changed%20in%20starbuck%20service%20to%20make%20use%20of%20JPA%20and%20MYSQL%201%20by%20use%20active%20order%20item%20instead%20of%20the%20hash%20map.PNG)
##### Active Order and new order is stored one new order method is called 
![img](./images/starbuck%20api/active%20order%20and%20new%20order%20is%20stored%20at%20the%20same%20time%20once%20new%20order%20API%20is%20called.PNG)
##### Updated delete all orders to delete all items from drinks, starbuck_order, and active_order tables to ensure consistent data state
![img](./images/starbuck%20api/updated%20delete%20all%20order%20to%20delete%20active%20orders%20and%20drinks%20for%20consistent%20state%20of%20MYSQL%20database.PNG)
##### Active order Class
![img](./images/starbuck%20api/active%20order%20class%20and%20table%20to%20store%20active%20order%20of%20current%20store.PNG)


1. RabbitMQ (10 points)
    Single POD Rabbit MQ deployment
##### Single pod prof by looking at the status of the rabit mq pod in GKE
![img](./images/rabbit%20mq/single%20pod%20rabbit%20mq.PNG)
##### Deployment manifestation
![img](./images/rabbit%20mq%20single%20pod%20deployment%20manifestation.PNG)
    Extend the Starbucks API to support async order processing (to use RabbitMQ)
##### Drink API added to check the status of the drink, the cashier will send message to queue after getting order whose status contains "paid"
###### Drink class and table to store fullfilled drink and for drink api endpoint to get the drink status
![img](./images/starbuck%20api/Drink%20class%20and%20table%20to%20keep%20track%20of%20drink%20item%20and%20fulfilled%20orders.PNG)
###### Drink controller for drink api endpoint
![img](./images/starbuck%20api/Drink%20controller%20for%20drink%20API%20endpoint.PNG)
##### cashier code that check the paid status of order found in get order action
![img](./images/cashier/Get%20order%20message%20from%20get%20order%20API%20and%20display%20the%20order%20on%20the%20view%20and%20handle%20sending%20message%20to%20cashier%20queue%20for%20worker%20to%20handle%20laater.PNG)
##### Drink endpoint in post man used to check status of drink
![img](./images/starbuck%20api/Starbuck%20rest%20API%20drink%20api.PNG)

#### Starbucks API for Mobile App and Store Front (25 points)
1. Deployed with Kong API Gateway with API Key Authentication (10 points)
##### Kong proxy endpoints
![img](./images/cloud%20deployment/kong%20proxy%20with%20external%20endpoints.PNG)
##### Curl at the kong endpoint with the authentication key instead of the api key, curl sucessfully
![img](./images/curl%20sucessfully%20for%20kong%20endpoint%20using%20auth%20key.PNG)

2. Implement RabbitMQ Check Order Status for "Drinks Available" (15 Points)
    Async Request API to "Make the Drink" once Order has been Paid (i.e. put request into a Queue)
##### The cashier app will handle this, user will click on get order, when the order return with status that contains "paid" in it, the cashier app will put request into the cashier queue
#### Get the paid order, once the order was retrieve from get order api, the app will check the status of such order, since it contains "paid" in the status, the app send the message to cashier queue for worker to handle the order id 12
![img](./images/order%20paid%20sent%20message%20to%20queue.PNG)

    Async Check Order Status API to "Check Status of Drink" in the Starbucks Database
##### Drink endpoint in post man used to check status of drink
![img](./images/starbuck%20api/Starbuck%20rest%20API%20drink%20api.PNG)
    Will need a Background Worker Job (i.e. Spring Scheduler) to pick up Orders and Make Drinks
#### Worker listen to the cashier queue, got the message and process the order id 12 to make drink
![img](./images/worker%20receieved%20and%20process%20order%20id%2012.PNG)
#### Queue become empty, order fullied and stored in drink table, also updated status fulfilled in active order, ready for the cashier to clear the active order
![img](./images/queue%20emptied%20order%20was%20fulfilled%20saved%20to%20both%20to%20order%20and%20drink.PNG)
    Background Worker should be a "Single Resilient POD" which auto restarts on crashes
#### a single pod Worker deployment in GKE
![img](./images/single%20worker%20deployment.PNG)
#### Deployment manifestation for single worker that keeps on restarting on crash
![img](./images/single%20resilient%20and%20mysql%20cloud%20used%20for%20spring%20worker.PNG)

## Journal Entries
### 3/30
Setting up the project, playing around with the code base
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/e036a8d947e9fe791510c5f5ce4d63be893bd48f

### 4/20
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/db7bac29a219db7cd9590d1c6ff5abcffb43176f
Looking at the project requirement, trying to add implementation to the cashier app
Adding spring-cashier to the project, configure the settings
Figuring out how to get order from the starbuck api

### 4/27
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/28aeedf350b544f0ddcc941ca3aa24ccc94f96e7
Added kong codes, cybersecurity codes from lab 7 and lab 8
Figuring out how to make api call to starbuck api end point from spring cashier

### 5/1
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/04cc7f1905c83605ecb658465f7d2f3ad62baaae
Try to play around with the starbuck-app, successfully pay with the card on this app
Try to add api call (get order) but got refused connection error

### 5/9
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/4d7e40a0c0ef1f103ab9050fc87a63d98d6d40fc
Working on the cashier app, try to add api call from cashier
added docker-compose.yaml and kong.yaml to project root folder

### 5/10
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/6b2064d0297713b978968e83697cbebd22f41d5b
Try to make the starbuck api work behind load balancer
added get order and new order functionality, need to work on get order and clear order
Get order sometime works, sometime does not
Try to work on the creating user and log in for security, got some error regarding name conflict while trying to run mvn package

### 5/11

Making the login and user authentication feature work
Created MySQL cloud
Created cmpe172 cluster
Made change to Starbuck api so that active order is stored in mysql database instead of using the hashmap
Forgot to push the change

### 5/13
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/9b9693097e8d4e162d2f239a56c582111f5decac
Added spring-cashier-worker to project, the worker could take in message from queue, fulfill the order and save the fulfill order in table drink 
Aslo update fulfill status for active order
updated star buck api to create drink api to retrieve fulfilled drink or order

### 5/14
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/4eda153667794887d6385a062c18a9c701881b93
Deploying spring-cashier-worker
Deployed successfully, my worker deployment failed because I did not have the spring-cashier deployed first so that it will create the queue for the worker to listern to and declare
After this I deployed spring-cashier first, then spring-cashier-worker
Project deployed, demo conducted

### 5/15
https://github.com/nguyensjsu/cmpe172-anhquangsjsu/commit/bfe133b632e2c6aaee0ff91624c350e8e35ff2b4
Wrapping up the journal and documentation

